<!DOCTYPE html>
<html>
  <head>
    <title>SlackDeck-Proto</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="wrapper">
      <ul class="horizontal-list">
        <!-- <div id="menu-bar"> <button onclick="opendev();">Open Dev Tool</button> </div> -->
        <!-- will create divs -->
      </ul>
    </div>

    <script>
      const json = require('./settings.json');
      const { shell } = require('electron')

      const contents = json.contents;
      contents.forEach(function(content, index) {
          createDiv(content['style'], content['width'], index);
      });

      const onlyBodyCss =
            ".client_channels_list_container { display: none !important; } #client_header { display: none !important; } #col_messages { width 100% !important; }";
      const onlyChannelCss =
            ".client_main_container { display: none !important; }";
      const onlySidebarCss =
            ".client_channels_list_container { display: none !important; } #col_messages { display: none !important; } .messages_header { display: none !important; }";

      const webviews = Array.from(document.getElementsByTagName("webview"));
      webviews.forEach(function(webview, index) {
          registerToOpenUrl(webview, shell);

          webview.addEventListener('dom-ready', function() {

              // webview.getWebContents().on('before-input-event', (event, input) => {
              //     if (input.type !== 'keyDown') { return; }
              //     if(input.key === "Backspace" && webview.canGoBack()) { webview.goBack(); }
              // });

              setWebviewAutosize(webview, 'on');

              if (checkUrlIsDefault(webview)) {
                  const channel = contents[index]['channel'];
                  const channelUrl = setChannelUrl(json.url, channel);
                  loadURL(webview, channelUrl);
              }

              selectAplicableCss(webview, { onlyBodyCss, onlyChannelCss, onlySidebarCss });
          });
      });

      function opendev() {
          const webviews = Array.from(document.getElementsByTagName("webview"));
          var webview = webviews[1];
          webview.goBack();
          webview.openDevTools();
      }
      function reload(index) {
          const targetTab = document.getElementById(index);
          var webview = null;
          targetTab.children[0].childNodes.forEach(function(element) {
              if(element.tagName == "WEBVIEW") { webview = element; }
          });
          webview.reload();
      }
      function remove(index) {
          var targetTab = document.getElementById(index);
          targetTab.parentNode.removeChild(targetTab);
      }
      function add() {
          const style = "body-only";
          const width = "large-tab";
          const channel = "general";
          const index = Array.from(document.getElementsByTagName("webview")).length;

          createDiv(style, width, index);

          var webview = Array.from(document.getElementsByTagName("webview"))[index];
          registerToOpenUrl(webview, shell);

          webview.addEventListener('dom-ready', function() {
              setWebviewAutosize(webview, 'on');

              if (checkUrlIsDefault(webview)) {
                  const channelUrl = setChannelUrl(json.url, channel);
                  loadURL(webview, channelUrl);
              }

              // Hack: These CSS are global objects
              selectAplicableCss(webview, { onlyBodyCss, onlyChannelCss, onlySidebarCss });
          });
      }
      function createDiv(style, width, index) {
          var div = document.createElement('div');
          div.id = index;
          div.className = width;

          var divTest = document.createElement('div');
          divTest.className = 'hoge';
          divTest.innerHTML = `<button onclick=reload(${index});>Reload</button>`;
          divTest.innerHTML += `<button onclick=remove(${index});>Remove Column</button>`;
          divTest.innerHTML += '<button onclick=add();>Add Column</button>';

          var divWebview = document.createElement('div');
          divWebview.className = 'webview';

          var webview = document.createElement('webview');
          webview.src = 'about:blank';
          webview.id = style;

          divWebview.appendChild(divTest);
          divWebview.appendChild(webview);
          div.appendChild(divWebview);

          var root = document.getElementsByClassName("horizontal-list")[0];
          root.appendChild(div);
      }
      function setWebviewAutosize(webview, autosize) {
          webview.autosize = autosize;
      }
      function selectAplicableCss(webview, { onlyBodyCss, onlyChannelCss, onlySidebarCss }) {
          if (shouldRenderOnlyBody(webview)) { applyCss(webview, onlyBodyCss); }
          if (shouldRenderOnlyChannelList(webview)) { applyCss(webview, onlyChannelCss); }
          if (shouldRenderOnlySidebar(webview)) { applyCss(webview, onlySidebarCss); }
      }
      function registerToOpenUrl(webview, shell) {
          webview.addEventListener('new-window', function(e){
              shell.openExternal(e.url);
          });
      }
      function setChannelUrl(baseUrl, channel) {
          const url = "messages/" + channel;
          return new URL(url, baseUrl).href.toString();
      }
      function shouldRenderOnlyChannelList(webview) {
          return webview.id == "channel-only";
      }
      function shouldRenderOnlyBody(webview) {
          return webview.id == "body-only";
      }
      function shouldRenderOnlySidebar(webview) {
          return webview.id == "sidebar-only";
      }
      function checkUrlIsDefault(webview) {
          return webview.attributes.src.value == "about:blank";
      }
      function loadURL(webview, url) {
          webview.loadURL(url.toString());
      }
      function applyCss(webview, css) {
          webview.insertCSS(css);
      }
      </script>

  </body>
</html>
